@model AutoService.Models.Entities.Request

@{
    ViewData["Title"] = $"Редактирование заявки #{Model.Id}";
}

<div class="fade-in">
    <!-- Навигация -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a asp-action="Index">Заявки</a>
            </li>
            <li class="breadcrumb-item">
                <a asp-action="Details" asp-route-id="@Model.Id">Заявка #@Model.Id</a>
            </li>
            <li class="breadcrumb-item active">Редактирование</li>
        </ol>
    </nav>

    <!-- Заголовок -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="display-6">
            <i class="bi bi-pencil-square text-warning me-2"></i>@ViewData["Title"]
        </h1>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-pencil me-2"></i>Редактирование заявки
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" asp-for="Id" />
                        <input type="hidden" asp-for="CreatedAt" />

                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

                        <!-- Дата начала -->
                        <div class="mb-3">
                            <label asp-for="StartDate" class="form-label">
                                <i class="bi bi-calendar me-1"></i>@Html.DisplayNameFor(m => m.StartDate)
                            </label>
                            <input asp-for="StartDate" class="form-control" type="date" />
                            <span asp-validation-for="StartDate" class="text-danger"></span>
                        </div>

                        <!-- Клиент -->
                        <div class="mb-3">
                            <label asp-for="ClientId" class="form-label">
                                <i class="bi bi-person me-1"></i>@Html.DisplayNameFor(m => m.ClientId)
                            </label>
                            <select asp-for="ClientId" class="form-select" asp-items="ViewBag.Clients">
                                <option value="">-- Выберите клиента --</option>
                            </select>
                            <span asp-validation-for="ClientId" class="text-danger"></span>
                        </div>

                        <!-- Автомобиль -->
                        <div class="mb-3">
                            <label asp-for="CarId" class="form-label">
                                <i class="bi bi-car-front me-1"></i>@Html.DisplayNameFor(m => m.CarId)
                            </label>
                            <select asp-for="CarId" class="form-select" asp-items="ViewBag.Cars">
                                <option value="">-- Выберите автомобиль --</option>
                            </select>
                            <span asp-validation-for="CarId" class="text-danger"></span>
                        </div>

                        <!-- Описание проблемы -->
                        <div class="mb-3">
                            <label asp-for="ProblemDescription" class="form-label">
                                <i class="bi bi-chat-dots me-1"></i>@Html.DisplayNameFor(m => m.ProblemDescription)
                            </label>
                            <textarea asp-for="ProblemDescription" class="form-control" rows="4"></textarea>
                            <span asp-validation-for="ProblemDescription" class="text-danger"></span>
                        </div>

                        <!-- Статус -->
                        <div class="mb-3">
                            <label asp-for="RequestStatus" class="form-label">
                                <i class="bi bi-tag me-1"></i>@Html.DisplayNameFor(m => m.RequestStatus)
                            </label>
                            <select asp-for="RequestStatus" class="form-select" asp-items="ViewBag.Statuses">
                            </select>
                            <span asp-validation-for="RequestStatus" class="text-danger"></span>
                        </div>

                        <!-- Мастер -->
                        <div class="mb-3">
                            <label asp-for="MasterId" class="form-label">
                                <i class="bi bi-tools me-1"></i>@Html.DisplayNameFor(m => m.MasterId)
                            </label>
                            <select asp-for="MasterId" class="form-select" asp-items="ViewBag.Mechanics">
                                <option value="">-- Не назначен --</option>
                            </select>
                            <span asp-validation-for="MasterId" class="text-danger"></span>
                        </div>

                        <!-- Запчасти -->
                        <div class="mb-3">
                            <label asp-for="RepairParts" class="form-label">
                                <i class="bi bi-gear me-1"></i>@Html.DisplayNameFor(m => m.RepairParts)
                            </label>
                            <textarea asp-for="RepairParts" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="RepairParts" class="text-danger"></span>
                        </div>

                        <!-- Дата завершения -->
                        <div class="mb-3">
                            <label asp-for="CompletionDate" class="form-label">
                                <i class="bi bi-calendar-check me-1"></i>@Html.DisplayNameFor(m => m.CompletionDate)
                            </label>
                            <input asp-for="CompletionDate" class="form-control" type="date" />
                            <span asp-validation-for="CompletionDate" class="text-danger"></span>
                        </div>

                        <!-- Кнопки -->
                        <div class="d-flex justify-content-between">
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Назад
                            </a>
                            <button type="submit" class="btn btn-warning">
                                <i class="bi bi-save me-2"></i>Сохранить изменения
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- История изменений -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-clock-history me-2"></i>Информация
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-3">
                            <strong>Создана:</strong><br />
                            <i class="bi bi-calendar me-1"></i> @Model.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                        </li>
                        @if (Model.UpdatedAt.HasValue)
                        {
                            <li class="mb-3">
                                <strong>Последнее изменение:</strong><br />
                                <i class="bi bi-calendar me-1"></i> @Model.UpdatedAt.Value.ToString("dd.MM.yyyy HH:mm")
                            </li>
                        }
                        <li class="mb-3">
                            <strong>Комментариев:</strong><br />
                            <i class="bi bi-chat me-1"></i> @(Model.Comments?.Count ?? 0)
                        </li>
                    </ul>

                    <hr />

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Будьте внимательны при изменении статуса заявки.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            // Предупреждение при изменении статуса на "Готова к выдаче"
            $('#RequestStatus').change(function() {
                if ($(this).val() === 'Готова к выдаче') {
                    if (!confirm('При изменении статуса на "Готова к выдаче" заявка будет считаться завершенной. Продолжить?')) {
                        $(this).val('@Model.RequestStatus');
                    }
                }
            });

            // Автозаполнение даты завершения при статусе "Готова к выдаче"
            if ($('#RequestStatus').val() === 'Готова к выдаче' && !$('#CompletionDate').val()) {
                var today = new Date().toISOString().split('T')[0];
                $('#CompletionDate').val(today);
            }
        });
    </script>
}